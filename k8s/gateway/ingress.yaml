---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: ecommerce-api
  namespace: ecommerce
spec:
  host: api.ecommerce.apps.openshift.example.com
  to:
    kind: Service
    name: api-gateway
  port:
    targetPort: 8000
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: ecommerce
spec:
  replicas: 2
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: kong
        image: kong:3.4-alpine
        ports:
        - containerPort: 8000
        - containerPort: 8001
        env:
        - name: KONG_DATABASE
          value: "off"
        - name: KONG_DECLARATIVE_CONFIG
          value: "/kong/declarative/kong.yml"
        - name: KONG_PROXY_ACCESS_LOG
          value: "/dev/stdout"
        - name: KONG_ADMIN_ACCESS_LOG
          value: "/dev/stdout"
        - name: KONG_PROXY_ERROR_LOG
          value: "/dev/stderr"
        - name: KONG_ADMIN_ERROR_LOG
          value: "/dev/stderr"
        volumeMounts:
        - name: kong-config
          mountPath: /kong/declarative
      volumes:
      - name: kong-config
        configMap:
          name: kong-config
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: ecommerce
spec:
  selector:
    app: api-gateway
  ports:
  - port: 8000
    targetPort: 8000
    name: proxy
  - port: 8001
    targetPort: 8001
    name: admin
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: ecommerce
data:
  kong.yml: |
    _format_version: "3.0"
    services:
      - name: product-service
        url: http://product-service:3001
        routes:
          - name: products
            paths:
              - /api/v1/products
      - name: auth-service
        url: http://auth-service:3002
        routes:
          - name: auth
            paths:
              - /api/v1/auth
      - name: order-service
        url: http://order-service:3003
        routes:
          - name: orders
            paths:
              - /api/v1/orders
      - name: payment-service
        url: http://payment-service:3004
        routes:
          - name: payments
            paths:
              - /api/v1/payments
